{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/user_profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/order.css' %}">
</head>
<body>
{% include 'partials/error_pop_up.html' %}
<div class="container">
    <div class="breadcrumbs">
        <a href="{% url 'user_home' %}">Home</a> / <span>Order History</span>
    </div>

    <!-- Mobile Dropdown Navigation -->
    <div class="dropdown">
        <select id="mobile-nav" onchange="navigateTo(this.value)">
            <option value="overview">Overview</option>
            <option value="personal-wallet">Personal Wallet</option>
            <option value="address-book">Address Book</option>
            <option value="change-password">Change Password</option>
            <option value="my-cart">My Cart</option>
            <option value="order-history" selected>Order History</option>
        </select>
    </div>

    <div class="main-content">
        {% include 'partials/sidebar.html' %}

        <div class="content">
            <h2>Order History</h2>
            <div class="order-history-items">
                {% for order in orders %}
                    <div class="order-item" onclick="openOrderDetails('{{ order.id }}')">
                        <div class="order-details">
                            <h3>Order #{{ order.id }}</h3>
                            <p>Date: {{ order.updated_at.date }}</p>
                            <p>Products:</p>
                            <ul>
                                {% for item in order.items.all %}
                                    <li>{{ item.product.name }}</li> <!-- Displaying the product name -->
                                {% empty %}
                                    <li>No products in this order.</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="order-actions">
                            <button type="button" class="view-details-button" onclick="openOrderDetails({{ order.id }})">View Details</button>
                            {% if order.status == 'cancelled' %}
                                <button class="cancel-order-button-disabled"onclick="event.stopPropagation();" disabled>Order Cancelled</button>
                            {% else %}
                                <form method="POST" action="{% url 'user_order_cancel' order.id %}" onclick="event.stopPropagation();">
                                    {% csrf_token %}
                                    <button type="submit" class="cancel-order-button" onclick="event.stopPropagation();">Cancel Order</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p>You have no orders in your history.</p>
                {% endfor %}
            </div>
            <div class="order-summary">
                <p>Total Orders: {{ orders.count }}</p>
                <!-- Add more summary details as needed -->
            </div>                  
        </div>
    </div>
    <!-- Modal for Order Details -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Order Details</h2>
            <div id="order-details-content">
                <!-- Order details will be loaded here dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
    function navigateTo(value) {
        const baseUrl = '/user_profile'; // Set this to your base user profile URL
        const url = `${baseUrl}/${value}`;
        window.location.href = url;
    }
</script>
<script>
    // Function to show the modal
    function openOrderDetails(orderId) {
        const modal = document.getElementById("orderDetailsModal");
        const content = document.getElementById("order-details-content");
    
        // Fetch order details using AJAX
        // Fetch order details using AJAX
    fetch(`/user_profile/user_order_details/${orderId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.json(); // Parse the JSON response
        })
        .then(data => {
            // Check if order.status is defined
            const orderStatusHtml = data.order.status
                ? `<p class="order-status-pop-up">Status: <span class="order-status-pop-up ${data.order.status.toLowerCase()}">${data.order.status}</span></p>`
                : ''; // If status is undefined, don't display it

            // Populate the modal with order details and add specific classes for styling
            const orderDetailsHtml = `
                <div class="order-header">
                    <h3 class="order-id">Order #${data.order.id}</h3>
                    <p class="order-date">Date: ${data.order.date}</p>
                    <p class="order-address">Address: ${data.order.address}</p>
                    ${orderStatusHtml}  <!-- Only show status if it's defined -->
                    <p class="order-status-pop-up">Payment Status: <span class="order-status-pop-up ${data.order.payment_status.toLowerCase()}">${data.order.payment_status}</span></p>
                </div>
                <ul class="order-items-list">
                    ${data.items.map(item => `
                        <li class="order-item">
                            <div class="item-details">
                                <img class="item-image" src="${item.product.image_url}" alt="${item.product.name}">
                                <div class="item-info">
                                    <span class="item-name">${item.product.name}</span> 
                                    <span class="item-quantity">Quantity: ${item.quantity}</span> 
                                    <span class="item-price">Price: $${Number(item.product.offer_price).toFixed(2)}</span>
                                    <span class="item-total-price">Total Price: $${Number(item.total_price).toFixed(2)}</span>
                                </div>
                            </div>
                        </li>
                    `).join('')}
                </ul>
                <div class="order-total-price">
                    <strong>Total Order Price: $${Number(data.total_price).toFixed(2)}</strong><br>
                    <strong>Total Price After Discount: $${Number(data.discounded_price).toFixed(2)}</strong>
                </div>
            `;

            // Insert the HTML into the modal content area
            content.innerHTML = orderDetailsHtml;

            // Display the modal
            modal.style.display = "flex";
        })
        .catch(error => {
            console.error('Error fetching order details:', error);
            content.innerHTML = `<p class="error-message">Error loading order details: ${error.message}</p>`;
            modal.style.display = "flex";
        });

    
        // Close the modal when the user clicks on <span> (x)
        document.querySelector(".close").onclick = function() {
            modal.style.display = "none";
        };
    
        // Close the modal when the user clicks outside of the modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };
    }

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all elements with the class 'nav-item'
        var navItems = document.querySelectorAll('.sidebar .nav-item');
    
        // Remove the 'selected' class from all nav-items
        navItems.forEach(function(item) {
            item.classList.remove('selected');
        });
    
        // Add the 'selected' class to the 'overview' nav-item
        var overviewLink = document.querySelector('.sidebar .order-history');
        if (overviewLink) {
            overviewLink.classList.add('selected');
        }
    });    
</script>
</body>
</html>